# 배경: 사설망과 공인망

IPv4는 2³²의 경우의 수를 제공하며, 이는 약 42억 개의 IP 주소를 의미합니다. 하지만 전 세계적으로 기기와 사용자가 증가하면서 공인 IP 주소는 할당 가능 수를 초과했습니다. 이는 **공인망**에서의 문제를 나타내며, **사설망**은 이를 보완하기 위한 대안으로 사용됩니다.

**사설망(Private Network)**은 공인망과는 다른 IP 주소 체계를 내부적으로 사용할 수 있습니다. 이는 **RFC 1918**과 **RFC 4193** 표준에 따라 규정되며, 내부적으로 네트워크를 관리하고 데이터를 통신합니다.

내부망에서 외부망으로 데이터를 보내려면 사용 중인 **사설 IP 주소(Private IP)**를 **공인 IP 주소(Public IP)**로 변환해야 하며, 이때 **NAT(Network Address Translation)** 기술이 필요합니다.

---

# NAT(Network Address Translation)

**NAT**는 **IP 패킷의 TCP/UDP 포트 번호**와 **소스 및 목적지 IP 주소**를 변환하여 네트워크 트래픽을 라우터를 통해 관리하는 기술입니다. NAT는 내부망과 외부망 간의 통신을 가능하게 하고, 네트워크 보안을 강화하며 공인 IP 주소의 부족 문제를 해결합니다. 또한, NAT는 **게이트웨이(Gateway)** 역할을 하기도 합니다.

## NAT의 상세 동작

- IP 주소뿐만 아니라 **TCP/UDP 포트 번호**도 변환할 수 있습니다.
- 이 기능을 **PAT(Port Address Translation)** 또는 **NAPT(Network Address and Port Translation)**라고 부릅니다.

### NAT를 통한 웹 요청 흐름 예시

1. 사용자가 `www.naver.com`에 접속하려고 요청을 보냅니다.
2. NAT는 다음과 같은 IP 주소와 포트를 변환하여 트래픽을 관리합니다:

   | 출발지 IP   | 출발지 Port | 목적지 IP       | 목적지 Port |
   | ----------- | ----------- | --------------- | ----------- |
   | 10.10.10.10 | 9999        | 125.209.222.142 | 80          |
   | 52.15.77.39 | 9999        | 125.209.222.142 | 80          |
   | 52.15.77.39 | 80          | 10.10.10.10     | 9999        |

3. NAT 동작 과정:

   - 클라이언트의 사설 IP와 포트를 공인 IP와 포트로 변환하여 요청을 웹서버로 보냅니다.
   - 웹서버가 요청을 처리하고 응답을 반환합니다.
   - NAT 장비는 응답 패킷의 목적지 IP와 포트를 클라이언트의 사설 IP와 포트로 변환하여 전달합니다.

4. NAT는 이러한 변환을 기억하는 상태(**Stateful**)로 동작하며, 요청과 응답의 관계를 추적합니다.

---

# NAT의 종류

1. **Static NAT(1:1 매핑)**: 하나의 사설 IP를 하나의 공인 IP에 정적으로 매핑.
2. **Dynamic NAT(1:N 매핑)**: 여러 사설 IP를 공인 IP 풀(pool)에서 동적으로 매핑.
3. **NAPT(PAT 포함)**: IP 주소뿐만 아니라 포트 번호까지 변환하여 N명의 사용자를 하나의 공인 IP로 처리.

---

# NAT의 세부 동작: SNAT과 DNAT

- **SNAT(Source NAT)**: 출발지 IP를 변환.
- **DNAT(Destination NAT)**: 목적지 IP를 변환.

---

# 세션 테이블과 Stateful 동작

NAT를 수행하는 장비는 네트워크 트래픽을 추적하고 관리하기 위해 **세션 테이블(Session Table)**을 사용합니다. 이 테이블은 트래픽의 소스/목적지 IP와 포트를 기록하며, 규칙에 따라 NAT를 수행합니다.

- **Stateful**: NAT 장비는 세션 상태를 추적하여, 이전 요청에 대한 응답 패킷을 적절히 변환하고 전달합니다.
- **세션 장비(Session Device)**: 방화벽과 같은 장비는 정해진 규칙에 따라 NAT를 수행하며, 세션 테이블에 기록된 정보를 활용합니다.

---

# VPN의 작동 원리와 NAT

**VPN(Virtual Private Network)**는 가상의 사설 네트워크로, 원격지에서도 사설망에 접속할 수 있도록 도와줍니다. VPN은 **Private Network**의 관점에서 NAT를 활용하며, 다음과 같은 특징을 가집니다:

1. **Virtual(가상화)**: 물리적 네트워크 대신 가상 터널을 통해 데이터가 전송됩니다.
2. **보안성**: NAT와 암호화를 사용하여 데이터 보안을 강화합니다.
3. **트래픽 관리**: NAT를 통해 사설망과 공인망 간의 데이터 교환을 수행합니다.

VPN과 NAT의 조합은 사설망을 효율적으로 관리하며, 보안을 강화하고 공인 IP 주소 부족 문제를 해결합니다.
